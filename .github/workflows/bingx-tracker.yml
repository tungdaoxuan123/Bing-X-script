name: BingX Portfolio Tracker with Perplexity Analysis (Every 60 min)


on:
  schedule:
    - cron: '*/8 * * * *'
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger


jobs:
  track-portfolio:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create Google credentials file
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
      run: |
        echo "$GOOGLE_CREDENTIALS" > google_credentials.json
    
    - name: Create BingX API key file
      env:
        BINGX_API_KEY: ${{ secrets.BINGX_API_KEY }}
        BINGX_API_SECRET: ${{ secrets.BINGX_API_SECRET }}
      run: |
        python3 << 'EOF'
        import json
        api_data = {
            "api_key": "${{ secrets.BINGX_API_KEY }}",
            "api_secret": "${{ secrets.BINGX_API_SECRET }}"
        }
        with open('api_key.json', 'w') as f:
            json.dump(api_data, f)
        EOF
    
    - name: Create Perplexity API key file
      env:
        PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
      run: |
        python3 << 'EOF'
        import json
        perplexity_data = {
            "api_key": "${{ secrets.PERPLEXITY_API_KEY }}"
        }
        with open('perplexity_key.json', 'w') as f:
            json.dump(perplexity_data, f)
        EOF
    
    - name: Run BingX tracker with Perplexity analysis
      env:
        GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
        BINGX_API_KEY: ${{ secrets.BINGX_API_KEY }}
        BINGX_API_SECRET: ${{ secrets.BINGX_API_SECRET }}
        PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
        GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
      run: |
        python3 bingx_to_sheets.py
    
    - name: Clean up sensitive files
      if: always()
      run: |
        rm -f api_key.json perplexity_key.json google_credentials.json
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "❌ BingX tracker with Perplexity analysis failed - check logs above"
    
    - name: Notify on success
      if: success()
      run: |
        echo "✅ BingX tracker with Perplexity analysis completed successfully"
